{% extends "datacollection/login_base.html" %}
{% load dc_extras %}

{% block title %}Cistrome Paper Collection - Datasets{% endblock %}
{% block include %}
<link href="{% url static_url %}css/datasets.css" rel="stylesheet" type="text/css"/>
<script src="{% url static_url %}js/prototype.js" type="text/javascript"></script>
<script src="{% url static_url %}js/settings.js" type="text/javascript"></script>
<script src="{% url static_url %}js/datasets.js" type="text/javascript"></script>
{% endblock %}

{% block onload %}
onload="init();"
{% endblock %}

{% block content %}
<!-- NOTE: the content is created in javascript -->
      {% if user.is_authenticated %}
      <input type="button" id="batchEdit" value="batch edit"/>
      <input type="button" id="deleteBtn" value="delete"/>
      {% endif %}
      {% if pg.paginator.num_pages %}
      <div class="pagination">
          <span class="step-links">
              {% if pg.has_previous %}
	      {% ifnotequal pg.previous_page_number 1 %}
	      <a href="?page=1{{rest}}">first</a>
	      {% endifnotequal %}
              <a href="?page={{pg.previous_page_number}}{{rest}}">previous</a>
              {% endif %}

              <span class="current">Page {{ pg.number }} of {{ pg.paginator.num_pages }}.</span>

              {% if pg.has_next %}
              <a href="?page={{ pg.next_page_number }}{{rest}}">next</a>
	      {% ifnotequal pg.next_page_number pg.paginator.num_pages %}
	      <a href="?page={{pg.paginator.num_pages}}{{rest}}">last</a>
	      {% endifnotequal %}
              {% endif %}
          </span>
      </div>
      {% endif %}
      <table class="datatable" id="datasets_table">
         <tr>{% if user.is_authenticated %}
	     <th><input type="checkbox" id="masterCheckbox"/></th>
	     {% endif %}
	     <th>ID</th>
	     <th>Paper</th>
	     <th>Treatments</th>
	     <th>Controls</th>
	     <th>Factor / Antibody</th>
	     <th>Experiment Type / Platform</th>
	     <th>Species</th>
	     <th>Cell / Tissue Type</th>
	     <th>Cell Line</th>
	     <th>Cell Pop</th>
	     <th>Strain</th>
	     <th>Condition</th>
	     <th>Disease State</th>
	     <th>Files</th>
	     <th>Status</th>
	     <th>Comments</th>
	     <th>Uploader</th>
	     <th>QC</th>
	     {% if user.is_authenticated %}
	     <th>Action</th>
	     {% endif %}
	 </tr>
	 {% for d in pg.object_list %}
	 <tr>
	     {% if user.is_authenticated %}
	     <td><input type="checkbox" class="rowSelect" id="{{d.id}}"/>
	         <a href="{% url update_dataset_form d.id %}?next={{request.get_full_path|urlencode }}">edit</a>
	     </td>
	     {% endif %}
	     <td><a href="{% url dataset_profile d.id %}">{{ d.id }}</a></td>
	     <td>
	       <a href="{% url paper_profile d.paper.id %}">paper profile</a><br/><br/>
	       <a href="http://www.ncbi.nlm.nih.gov/pubmed?term={{d.paper.pmid}}" target="_blank">{{ d.paper.pmid }}</a><br/><br/>
	       <a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc={{d.paper.gseid}}" target="_blank">{{ d.paper.gseid }}</a>
	     </td>
	     <td>{% for g in d.treatments_gsmid %}
	         <span>{{g}}</span>
		 {% endfor %}
	     </td>
	     <td>{% for g in d.controls_gsmid %}
	         <span>{{g}}</span>
		 {% endfor %}
	     </td>
	     <td>
	       <a href="{% url datasets %}?factor={{d.factor.id}}">{{d.factor.name}}</a><br/><br/>
	       <a href="{% url datasets %}?antibody={{d.factor.id}}">{{d.factor.antibody}}</a>
	     </td>
	     <td>
	       {{d.platform.get_experiment_type_display}}<br/><br/>
	       <a href="{%url datasets %}?platform={{d.platform.id}}">{{d.platform.name}}</a>
	     </td>
	     <td><a href="{% url datasets %}?species={{d.species.id}}">{{d.species}}</a></td>
	     <td>
	       <a href="{% url datasets %}?celltype={{d.cell_type.id}}">{{d.cell_type.name}}</a><br/><br/>
	       <a href="{% url datasets %}?tissuetype={{d.cell_type.id}}">{{d.cell_type.tissue_type}}</a>
	     </td>
	     <td><a href="{% url datasets %}?cellline={{d.cell_line.id}}">{{d.cell_line.name}}</a></td>
	     <td><a href="{% url datasets %}?cellpop={{d.cell_pop.id}}">{{d.cell_pop.name}}</a></td>
	     <td><a href="{% url datasets %}?strain={{d.strain.id}}">{{d.strain.name}}</a></td>
	     <td><a href="{% url datasets %}?condition={{d.condition.id}}">{{d.condition.name}}</a></td>
	     <td><a href="{% url datasets %}?diseasestate={{d.disease_state.id}}">{{d.disease_state.name}}</a></td>
	     <td>	       
	       {% for f in d.getFileFields%}
	       {% if f %}
	       <span><a href="{{f.url|sub_site}}">{{f.field.name}}</a></span></br>
	       {% endif %}
	       {% endfor %}

	     </td>

	     {% ifequal d.status "new" %}
	     <td class="new_row">{{ d.get_status_display }}</td>
	     {% else %} {% ifequal d.status "checked" %}
	     <td class="checked_row">{{ d.get_status_display }}</td>
	     {% else %} {% ifequal d.status "running" %}
	     <td class="running_row">{{ d.get_status_display }}</td>
	     {% else %} {% ifequal d.status "complete" %}
	     <td class="complete_row">{{ d.get_status_display }}</td>
	     {% else %} {% ifequal d.status "error" %}
	     <td class="error_row">{{ d.get_status_display }}</td>
	     {% else %}
	     <td>{{ d.get_status_display }}</td>
	     {% endifequal %}{% endifequal %}{% endifequal %}{% endifequal %}{% endifequal %}
	     <td>{{ d.comments }}</td>
	     <td>{{ d.uploader }}<br/><br/>
	         {{ d.upload_date|date:"Y-m-d" }}
	     </td>
	     <td>
	       {% if d.read_qc %}<span>Read:{{d.read_qc}}</span><br/>{% endif %}
	       {% if d.model_qc %}<span>Model:{{d.model_qc}}</span><br/>{% endif %}
	       {% if d.fold_qc %}<span>Fold:{{d.fold_qc}}</span><br/>{% endif %}
	       {% if d.fdr_qc %}<span>FDR:{{d.fdr_qc}}</span><br/>{% endif %}
	       {% if d.replicate_qc %}<span>Replicate:{{d.replicate_qc}}</span><br/>{% endif %}
	       {% if d.dnase_qc %}<span>DNase:{{d.dnase_qc}}</span><br/>{% endif %}
	       {% if d.velcro_qc %}<span>Velcro:{{d.velcro_qc}}</span><br/>{% endif %}
	       {% if d.conserve_qc %}<span>Conserve:{{d.conserve_qc}}</span><br/>{% endif %}
	       {% if d.ceas_qc %}<span>CEAS:{{d.ceas_qc}}</span><br/>{% endif %}
	       {% if d.motif_qc %}<span>Motif:{{d.motif_qc}}</span><br/>{% endif %}
	       {% if d.overall_qc %}<span>Overall:{{d.overall_qc}}</span><br/>{% endif %}
	     </td>
	     {% comment %} ACTIONS HERE {% endcomment %}
	     {% if user.is_authenticated %}
	     {% ifequal d.status "new" %}
	     <td><input type="button" value="check raw files" onclick="checkRawFiles({{d.id}}, {{pg.number}});"/></td>
	     {% else %} {% ifequal d.status "checked" %}
	     <td><input type="button" value="run!" onclick="runAnalysis({{d.id}}, {{pg.number}});"/></td>
	     {% else %} {% ifequal d.status "running" %}
	     <td><input type="button" value="run!" disabled="true"/></td>
	     {% else %} 
	     <td> </td>
	     {% endifequal %}{% endifequal %}{% endifequal %}
	     {% endif %} 
	 </tr>
	 {% endfor %}
      </table>
      {% if pg.paginator.num_pages %}
      <div class="pagination">
          <span class="step-links">
              {% if pg.has_previous %}
	      {% ifnotequal pg.previous_page_number 1 %}
	      <a href="?page=1{{rest}}">first</a>
	      {% endifnotequal %}
              <a href="?page={{pg.previous_page_number}}{{rest}}">previous</a>
              {% endif %}

              <span class="current">Page {{ pg.number }} of {{ pg.paginator.num_pages }}.</span>

              {% if pg.has_next %}
              <a href="?page={{ pg.next_page_number }}{{rest}}">next</a>
	      {% ifnotequal pg.next_page_number pg.paginator.num_pages %}
	      <a href="?page={{pg.paginator.num_pages}}{{rest}}">last</a>
	      {% endifnotequal %}
              {% endif %}
          </span>
      </div>
      {% endif %}
{% endblock %}

